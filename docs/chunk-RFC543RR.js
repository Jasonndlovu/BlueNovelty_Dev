import{a as P}from"./chunk-GJRON2FT.js";import{f as T,h as R,j as U,k as l,l as B,m as g,n as M,o as u,r as k,s as I,t as p,u as O,v as z,w as y,x as G}from"./chunk-L2HEO6U7.js";import{B as E,E as A,j as q,k as $,m as b,n as j,y as v}from"./chunk-KV6L2PIJ.js";import{a as F,g as m}from"./chunk-OLRFWS6T.js";var X=(()=>{let h=class h{constructor(s,t){this.firestore=s,this.authService=t}sendMessage(s,t,a,o,i){return m(this,null,function*(){let e=yield b(this.authService.getCurrentUser());if(!e){console.error("User not authenticated");return}let r=this.generateChatId(e.uid,o),n=l(this.firestore,`chats/${r}/messages`),c=g(this.firestore,`chats/${r}`),w=new Date,D={text:s,senderId:t,sender:e.displayName||"Anonymous",senderImage:a||"assets/default-avatar.png",receiverId:o,receiverImage:i||"assets/default-avatar.png",timestamp:w,participants:[e.uid,o],readBy:[t]};yield U(n,D);let d=yield M(c),f={text:s,senderId:t,timestamp:w};if(d.exists()){let S=d.data().participants||[],Q=Array.from(new Set([...S,e.uid,o]));yield z(c,{lastMessage:f,participants:Q})}else yield O(c,{participants:[e.uid,o],lastMessage:f})})}getLastMessage(s){return m(this,null,function*(){let t=this.listenToUserChats(s),a=l(this.firestore,`chats/${t}/messages`),o=p(a,I("timestamp","desc"),k(1)),i=yield u(o);if(!i.empty){let r=i.docs[0].data();return{text:r.text,timestamp:r.timestamp,senderId:r.senderId}}return null})}getMessages(s,t){if(!s||!t)return console.warn("Current user ID or chat partner ID is missing"),$([]);console.log("currentUserId :"+s),console.log("chatPartnerId :"+t);let a=this.generateChatId(s,t),o=l(this.firestore,`chats/${a}/messages`),i=p(o,I("timestamp"));return R(i)}generateChatId(s,t){return[s,t].sort().join("_")}getUsersChattedWith(s){return m(this,null,function*(){console.log("[1] Checking chats for user:",s);let t=[],a=new Set;try{let o=l(this.firestore,"chats"),i=yield u(o);console.log(o),console.log("[2] Total chat containers:",i.size),i.forEach(e=>{let r=e.id,[n,c]=r.split("_");n===s&&c!==s?a.add(c):c===s&&n!==s&&a.add(n)}),console.log("[3] Unique partners:",Array.from(a));for(let e of a){let r=g(this.firestore,"users",e),n=yield M(r);n.exists()&&t.push(F({uid:e},n.data()))}return t}catch(o){return console.error("[ERROR] Failed to get chat partners:",o),[]}})}markMessagesAsRead(s,t){return m(this,null,function*(){let a=l(this.firestore,`chats/${s}/messages`),o=p(a,y("readBy","not-in",[t])),i=yield u(o),e=G(this.firestore);i.forEach(r=>{let n=g(this.firestore,`chats/${s}/messages/${r.id}`);e.update(n,{readBy:[...r.data().readBy||[],t]})}),yield e.commit()})}listenToUnreadMessages(s){let t=p(B(this.firestore,"messages"),y("participants","array-contains",s),y("readBy","not-in",[s]));return R(t).pipe(j(a=>a.length))}getChatIdsForUser(s){return m(this,null,function*(){console.log("[1] Getting chat IDs for user:",s);let t=new Set;try{let a=p(B(this.firestore,"messages"),I("timestamp")),o=yield u(a);return console.log("[2] Total messages found:",o.size),o.forEach(i=>{let r=i.ref.path.split("/")[1],[n,c]=r.split("_");(n===s||c===s)&&t.add(r)}),console.log("[3] Found chat IDs:",Array.from(t)),Array.from(t)}catch(a){return console.error("[ERROR] Failed to get chat IDs:",a),[]}})}listenToUserChats(s){let t=l(this.firestore,"chats"),a=p(t,y("participants","array-contains",s));return R(a,{idField:"id"}).pipe(v(o=>{let i=o.map(e=>m(this,null,function*(){var D,d,f,C;let r=e.participants.find(S=>S!==s),n=g(this.firestore,"users",r),c=yield M(n),w=c.exists()?c.data():null;return{chatId:e.id,otherUserId:r,otherUser:w,senderId:((D=e.lastMessage)==null?void 0:D.senderId)||null,lastMessage:((d=e.lastMessage)==null?void 0:d.text)||"",timestamp:((C=(f=e.lastMessage)==null?void 0:f.timestamp)==null?void 0:C.toDate())||null}}));return q(Promise.all(i))}))}};h.\u0275fac=function(t){return new(t||h)(A(T),A(P))},h.\u0275prov=E({token:h,factory:h.\u0275fac,providedIn:"root"});let x=h;return x})();export{X as a};
