import{a as B}from"./chunk-ZZSRRRLF.js";import{c as E,e as C,g as T,h as m,i as $,j as D,k as y,l as w,o as O,p as I,q as f,r as U,s as k,t as z}from"./chunk-6CACEU2V.js";import{B as b,E as S,j as A,k as q,m as j,y as v}from"./chunk-RFSKJ54S.js";import{a as F,g as h}from"./chunk-OLRFWS6T.js";var J=(()=>{let l=class l{constructor(t,s){this.firestore=t,this.authService=s}sendMessage(t,s,o,e,i){return h(this,null,function*(){let a=yield j(this.authService.getCurrentUser());if(!a){console.error("User not authenticated");return}let r=this.generateChatId(a.uid,e),n=m(this.firestore,`chats/${r}/messages`),c=D(this.firestore,`chats/${r}`),g=new Date,u={text:t,senderId:s,sender:a.displayName||"Anonymous",senderImage:o||"assets/default-avatar.png",receiverId:e,receiverImage:i||"assets/default-avatar.png",timestamp:g,participants:[a.uid,e]};yield T(n,u);let p=yield y(c),d={text:t,senderId:s,timestamp:g};if(p.exists()){let M=p.data().participants||[],G=Array.from(new Set([...M,a.uid,e]));yield k(c,{lastMessage:d,participants:G})}else yield U(c,{participants:[a.uid,e],lastMessage:d})})}getLastMessage(t){return h(this,null,function*(){let s=this.listenToUserChats(t),o=m(this.firestore,`chats/${s}/messages`),e=f(o,I("timestamp","desc"),O(1)),i=yield w(e);if(!i.empty){let r=i.docs[0].data();return{text:r.text,timestamp:r.timestamp,senderId:r.senderId}}return null})}getMessages(t,s){if(!t||!s)return console.warn("Current user ID or chat partner ID is missing"),q([]);console.log("currentUserId :"+t),console.log("chatPartnerId :"+s);let o=this.generateChatId(t,s),e=m(this.firestore,`chats/${o}/messages`),i=f(e,I("timestamp"));return C(i)}generateChatId(t,s){return[t,s].sort().join("_")}getUsersChattedWith(t){return h(this,null,function*(){console.log("[1] Checking chats for user:",t);let s=[],o=new Set;try{let e=m(this.firestore,"chats"),i=yield w(e);console.log(e),console.log("[2] Total chat containers:",i.size),i.forEach(a=>{let r=a.id,[n,c]=r.split("_");n===t&&c!==t?o.add(c):c===t&&n!==t&&o.add(n)}),console.log("[3] Unique partners:",Array.from(o));for(let a of o){let r=D(this.firestore,"users",a),n=yield y(r);n.exists()&&s.push(F({uid:a},n.data()))}return s}catch(e){return console.error("[ERROR] Failed to get chat partners:",e),[]}})}getChatIdsForUser(t){return h(this,null,function*(){console.log("[1] Getting chat IDs for user:",t);let s=new Set;try{let o=f($(this.firestore,"messages"),I("timestamp")),e=yield w(o);return console.log("[2] Total messages found:",e.size),e.forEach(i=>{let r=i.ref.path.split("/")[1],[n,c]=r.split("_");(n===t||c===t)&&s.add(r)}),console.log("[3] Found chat IDs:",Array.from(s)),Array.from(s)}catch(o){return console.error("[ERROR] Failed to get chat IDs:",o),[]}})}listenToUserChats(t){let s=m(this.firestore,"chats"),o=f(s,z("participants","array-contains",t));return C(o,{idField:"id"}).pipe(v(e=>{let i=e.map(a=>h(this,null,function*(){var u,p,d,x;let r=a.participants.find(M=>M!==t),n=D(this.firestore,"users",r),c=yield y(n),g=c.exists()?c.data():null;return{chatId:a.id,otherUserId:r,otherUser:g,senderId:((u=a.lastMessage)==null?void 0:u.senderId)||null,lastMessage:((p=a.lastMessage)==null?void 0:p.text)||"",timestamp:((x=(d=a.lastMessage)==null?void 0:d.timestamp)==null?void 0:x.toDate())||null}}));return A(Promise.all(i))}))}};l.\u0275fac=function(s){return new(s||l)(S(E),S(B))},l.\u0275prov=b({token:l,factory:l.\u0275fac,providedIn:"root"});let R=l;return R})();export{J as a};
